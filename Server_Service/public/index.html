<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Tester</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f4f8;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            width: 100%;
        }
        h1, h2 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
        }
        .form-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        input[type="text"], input[type="number"], textarea {
            flex: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
        }
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        input[type="text"]:focus, input[type="number"]:focus, textarea:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.3);
        }
        input:disabled {
            background-color: #f0f0f0;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        .btn-primary:hover {
            background-color: #0056b3;
        }
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        .btn-success:hover {
            background-color: #1e7e34;
        }
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        .btn-danger:hover {
            background-color: #b02a37;
        }
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #545b62;
        }
        .response, .error {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }
        .response {
            background-color: #d4edda;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .keys-list {
            margin-bottom: 20px;
        }
        .keys-list ul {
            list-style: none;
            padding: 0;
        }
        .keys-list li {
            padding: 10px;
            background-color: #f8f9fa;
            margin-bottom: 5px;
            border-radius: 5px;
        }
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .active-keys {
            margin-bottom: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border: 1px solid #ddd;
        }
        th {
            background-color: #007bff;
            color: white;
        }
        tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        @media (max-width: 600px) {
            .form-group {
                flex-direction: column;
            }
            input[type="text"], input[type="number"], textarea {
                width: 100%;
            }
            table {
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>API Tester</h1>

        <!-- Form để set một key-value -->
        <h2>Set Single Key</h2>
        <form id="setForm" class="form-group">
            <input type="text" id="setKey" placeholder="Key (e.g., CAMERA_A)" required>
            <input type="text" id="setValue" placeholder="Value (e.g., 1)" required>
            <div class="checkbox-group">
                <input type="number" id="setTtl" placeholder="TTL (ms)" value="3000">
                <label>
                    <input type="checkbox" id="permanent" onclick="toggleTtl()"> Permanent
                </label>
            </div>
            <button type="submit" class="btn-primary">Set Value</button>
        </form>

        <!-- Form để set nhiều key-value -->
        <h2>Set Multiple Keys</h2>
        <form id="setMultipleForm" class="form-group">
            <textarea id="setMultipleJson" placeholder='Enter JSON array, e.g. [{"key":"A","value":1,"ttl":3000},{"key":"B","value":0}]' required></textarea>
            <button type="submit" class="btn-primary">Set Multiple Values</button>
        </form>

        <!-- Form để get value -->
        <h2>Get Value</h2>
        <div class="form-group">
            <input type="text" id="getKey" placeholder="Key to get">
            <button onclick="handleGet()" class="btn-success">Get Value</button>
        </div>

        <!-- Form để delete key -->
        <h2>Delete Key</h2>
        <div class="form-group">
            <input type="text" id="deleteKey" placeholder="Key to delete">
            <button onclick="handleDelete()" class="btn-danger">Delete Key</button>
        </div>

        <!-- Danh sách keys -->
        <div class="keys-list">
            <h2>Current Keys</h2>
            <button onclick="fetchKeys()" class="btn-secondary">Refresh Keys</button>
            <ul id="keysList"></ul>
        </div>

        <!-- Bảng key hiện hoạt -->
        <div class="active-keys">
            <h2>Active Keys</h2>
            <table id="activeKeysTable">
                <thead>
                    <tr>
                        <th>Key</th>
                        <th>Value</th>
                        <th>Status</th>
                        <th>Expires At</th>
                    </tr>
                </thead>
                <tbody id="activeKeysBody"></tbody>
            </table>
        </div>

        <!-- Thông báo -->
        <div id="response" class="response"></div>
        <div id="error" class="error"></div>
    </div>

    <script>
        const API_URL = 'http://localhost:3000';
        let keyCache = {};

        // Bật/tắt input TTL khi checkbox Permanent được chọn
        function toggleTtl() {
            const ttlInput = document.getElementById('setTtl');
            const permanentCheckbox = document.getElementById('permanent');
            ttlInput.disabled = permanentCheckbox.checked;
            if (permanentCheckbox.checked) {
                ttlInput.value = '';
            } else {
                ttlInput.value = '3000';
            }
        }

        // Hiển thị thông báo
        function showMessage(elementId, message, isError = false) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.style.display = 'block';
            setTimeout(() => {
                element.style.display = 'none';
            }, 3000);
        }

        // Xử lý form set một key-value
        document.getElementById('setForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const key = document.getElementById('setKey').value;
            const value = document.getElementById('setValue').value;
            const ttl = document.getElementById('setTtl').value;
            const permanent = document.getElementById('permanent').checked;

            const body = permanent ? { key, value } : { key, value, ttl: parseInt(ttl) };

            try {
                const res = await fetch(`${API_URL}/set`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                const data = await res.json();
                if (res.ok) {
                    const msg = permanent ? `Set ${key} = ${value} (permanent)` : `Set ${key} = ${value} with TTL ${ttl}ms`;
                    showMessage('response', msg);
                    document.getElementById('setForm').reset();
                    document.getElementById('setTtl').disabled = false;
                    document.getElementById('permanent').checked = false;
                    await fetchKeys();
                    await fetchActiveKeys(true);
                } else {
                    showMessage('error', data.errors ? data.errors[0].error : 'Failed to set value', true);
                }
            } catch (err) {
                showMessage('error', 'Error connecting to server', true);
            }
        });

        // Xử lý form set nhiều key-value
        document.getElementById('setMultipleForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const jsonInput = document.getElementById('setMultipleJson').value;

            try {
                const items = JSON.parse(jsonInput);
                if (!Array.isArray(items)) {
                    throw new Error('Input must be a JSON array');
                }

                const res = await fetch(`${API_URL}/set`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(items)
                });
                const data = await res.json();
                if (res.ok) {
                    const msg = `Set ${data.results.length} key(s) successfully`;
                    showMessage('response', msg);
                    document.getElementById('setMultipleForm').reset();
                    await fetchKeys();
                    await fetchActiveKeys(true);
                } else {
                    const errorMsg = data.errors ? data.errors.map(e => `${e.key}: ${e.error}`).join('; ') : 'Failed to set values';
                    showMessage('error', errorMsg, true);
                }
            } catch (err) {
                showMessage('error', `Invalid JSON or error: ${err.message}`, true);
            }
        });

        // Xử lý get value
        async function handleGet() {
            const key = document.getElementById('getKey').value;
            if (!key) {
                showMessage('error', 'Please enter a key', true);
                return;
            }
            try {
                const res = await fetch(`${API_URL}/get/${key}`);
                const data = await res.json();
                showMessage('response', `Value of ${key}: ${data.value}`);
            } catch (err) {
                showMessage('error', 'Error connecting to server', true);
            }
        }

        // Xử lý delete key
        async function handleDelete() {
            const key = document.getElementById('deleteKey').value;
            if (!key) {
                showMessage('error', 'Please enter a key', true);
                return;
            }
            try {
                const res = await fetch(`${API_URL}/delete/${key}`, {
                    method: 'DELETE'
                });
                const data = await res.json();
                if (res.ok) {
                    showMessage('response', `Deleted ${key}`);
                    document.getElementById('deleteKey').value = '';
                    await fetchKeys();
                    await fetchActiveKeys(true);
                } else {
                    showMessage('error', data.error || 'Failed to delete key', true);
                }
            } catch (err) {
                showMessage('error', 'Error connecting to server', true);
            }
        }

        // Lấy và hiển thị danh sách keys
        async function fetchKeys() {
            try {
                const res = await fetch(`${API_URL}/keys`);
                const data = await res.json();
                const keysList = document.getElementById('keysList');
                keysList.innerHTML = '';
                if (data.keys && data.keys.length > 0) {
                    data.keys.forEach(key => {
                        const li = document.createElement('li');
                        li.textContent = key;
                        keysList.appendChild(li);
                    });
                } else {
                    keysList.innerHTML = '<li>No keys found</li>';
                }
            } catch (err) {
                showMessage('error', 'Error fetching keys', true);
            }
        }

        // Lấy và hiển thị bảng key hiện hoạt
        async function fetchActiveKeys(forceRefresh = false) {
            try {
                let keys = Object.keys(keyCache);
                if (forceRefresh) {
                    const res = await fetch(`${API_URL}/keys`);
                    keys = (await res.json()).keys || [];
                }

                const tableBody = document.getElementById('activeKeysBody');
                const newCache = {};

                for (const key of keys) {
                    let value, expiresAt, status;
                    if (forceRefresh || !keyCache[key]) {
                        const res = await fetch(`${API_URL}/get/${key}`);
                        const data = await res.json();
                        value = data.value;

                        // Giả lập lấy thông tin TTL và expiresAt
                        const tempRes = await fetch(`${API_URL}/set`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ key, value, ttl: null })
                        });
                        const tempData = await tempRes.json();
                        expiresAt = tempData.ttl ? Date.now() + tempData.ttl : null;
                        status = tempData.ttl ? 'Temporary' : 'Permanent';
                    } else {
                        value = keyCache[key].value;
                        expiresAt = keyCache[key].expiresAt;
                        status = keyCache[key].status;
                    }

                    // Kiểm tra TTL cục bộ
                    if (expiresAt && expiresAt <= Date.now()) {
                        value = 0;
                    }

                    newCache[key] = { value, expiresAt, status };

                    // Cập nhật hoặc tạo dòng trong bảng
                    let row = document.getElementById(`key-row-${key}`);
                    if (!row) {
                        row = document.createElement('tr');
                        row.id = `key-row-${key}`;
                        row.innerHTML = `
                            <td>${key}</td>
                            <td id="value-${key}">${value}</td>
                            <td id="status-${key}">${status}</td>
                            <td id="expires-${key}">${expiresAt ? new Date(expiresAt).toLocaleString() : 'Never'}</td>
                        `;
                        tableBody.appendChild(row);
                    } else {
                        const valueCell = document.getElementById(`value-${key}`);
                        const statusCell = document.getElementById(`status-${key}`);
                        const expiresCell = document.getElementById(`expires-${key}`);
                        if (valueCell.textContent !== value.toString()) {
                            valueCell.textContent = value;
                        }
                        if (statusCell.textContent !== status) {
                            statusCell.textContent = status;
                        }
                        if (expiresCell.textContent !== (expiresAt ? new Date(expiresAt).toLocaleString() : 'Never')) {
                            expiresCell.textContent = expiresAt ? new Date(expiresAt).toLocaleString() : 'Never';
                        }
                    }
                }

                // Xóa các dòng không còn trong keys
                const existingRows = tableBody.getElementsByTagName('tr');
                for (const row of existingRows) {
                    const key = row.id.replace('key-row-', '');
                    if (!keys.includes(key)) {
                        row.remove();
                    }
                }

                keyCache = newCache;

                if (keys.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="4">No active keys</td></tr>';
                }
            } catch (err) {
                showMessage('error', 'Error fetching active keys', true);
            }
        }

        // Tải keys và bảng khi trang mở
        fetchKeys();
        fetchActiveKeys(true);

        // Tự động cập nhật bảng mỗi 1 giây
        setInterval(() => fetchActiveKeys(true), 1000);
    </script>
</body>
</html>